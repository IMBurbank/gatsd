#!/bin/sh

# Docker Build
# Call from host project dir to build docker image

. "$(dirname $0)/_default.conf"
cd "$(dirname $0)" || { echo "Could not change to $(dirname $0)"; exit 1; }


##### CONSTANTS #####
GATSD_VERSION="${GATSD_VERSION}"
SITE_NAME="${SITE_NAME}"
GATSD_DIRNAME="${GATSD_DIRNAME}"
WORK_DIR="/${SITE_NAME}"
GATSD_DIR="${WORK_DIR}/${GATSD_DIRNAME}"


##### VARIABLES #####
gatsd_files="_gatsd _default.conf _bashrc build develop new run serve stage"
gatsby_dir="$(dirname $(pwd))"


##### FLAGS #####
tag_name=${BUILD_TAG}			# flag -t
gatsby_port=${GATSBY_PORT}		# flag -p
gatsby_host=${GATSBY_HOST}		# flag -H

while getopts ":H:t:p:" flag; do
	case "${flag}" in
		H) 
			gatsby_host="${OPTARG}"
			;;
		p) 
			gatsby_port="${OPTARG}"
			;;
		t) 
			tag_name="${OPTARG}"
			;;
		*) 
			echo "ERROR: Invalid flag ${flag}"
			exit 1
			;;
	esac
done
shift `expr $OPTIND - 1`


##### MAIN #####
if [ -z "$(grep -q Microsoft /proc/version)" ]; then
	gatsby_dir=$(wslpath -m ${gatsby_dir})
	echo "WSL detected. Converted gatsby_dir to ${gatsby_dir}"
else
	echo "NATIVE"
fi

cat << SHIM > _gatsd-shim
#!/usr/bin/env bash

# GatsD Shim
# ***GENERATED FILE*** PERMANENT CHANGES MUST BE MADE IN 'docker-build'
# Shim to gatsby-docker.sh in project dir

${GATSD_DIR}/_gatsd \$@
SHIM

cat << ENV > _build-env
# GatsD Build Environment
# ***GENERATED FILE*** PERMANENT CHANGES MUST BE MADE IN 'docker-build'
# Docker container build environment
GATSD_VERSION=${GATSD_VERSION}
SITE_NAME=${SITE_NAME}
WORK_DIR=${WORK_DIR}
GATSD_DIR=${GATSD_DIR}
GATSD_DIRNAME=${GATSD_DIRNAME}
GATSBY_DIR=${gatsby_dir}
GATSBY_HOST=${gatsby_host}
GATSBY_PORT=${gatsby_port}
TAG_NAME=${tag_name}
ENV

gatsd_files="${gatsd_files} _gatsd-shim _build-env"
for el in ${gatsd_files}; do
	chmod +rx "$el"
done

cd .. || { echo "Could not change to $(dirname $(pwd))"; exit 1; }

#
# Modify docker build as needed 
#
docker build \
	-f "${GATSD_DIRNAME}/Dockerfile" \
	-t "${tag_name}" \
	--build-arg  WORK_DIR="${WORK_DIR}" \
	--build-arg  SITE_NAME="${SITE_NAME}" \
	--build-arg  GATSD_DIR="${GATSD_DIR}" \
	--build-arg  GATSD_DIRNAME="${GATSD_DIRNAME}" \
	--build-arg  GATSD_VERSION="${GATSD_VERSION}" \
	--build-arg  GATSBY_HOST="${gatsby_host}" \
	--build-arg  GATSBY_PORT="${gatsby_port}" \
	. \
	&& \
cat <<- INFO
	-------------------------------------------------------------------
	Docker build complete. Run: gatsd/new <site-url>
	to download initialize a gatsby site from the site-url.
	NOTE: Only github repo urls can be used (https://github.com/*)
	NOTE: Name of current working directory will be used for site name
	-------------------------------------------------------------------
INFO